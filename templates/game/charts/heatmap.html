<script>
var charData = {}
var elevation = {{ elevation|safe }} 
var rainfall = {{ rainfall|safe }} 
var terrain = {{ terrain|safe }} 

</script>
<style>
   rect.bordered {
   stroke: #bbb;
   stroke-width:3px;   
   }
   text.mono {
   font-size: 9pt;
   font-family: verdana;
   fill: #aaa;
   }
   text.mono:hover {
   font-size: 12pt;
   font-family: verdana;
   fill: #aaa;
   font-weight: bold;
   }
   .square {
   opacity: 0.5;
   }
   .square:hover {
   opacity: 1.0;
   }
   .d3-tip {
   font-family: Verdana;
   background: rgba(0, 0, 0, 0.8);
   padding: 8px;
   color: #fff; 
   z-index: 5070;
   }
</style>
<button type="button" id="elevation">elevation</button>
<button type="button" id="rainfall">rainfall</button>
<script type="text/javascript">
   var data = []
   var dims = Object.entries(df_features)
   var dim_1 = []
   var dim_2 = []
   for (i in dims){
        if (dim_1.indexOf(parseInt(Object.entries(df_features)[i][0].split(":")[0]))<0)
            {dim_1.push(parseInt(Object.entries(df_features)[i][0].split(":")[0]))}
        if (dim_2.indexOf(parseInt(Object.entries(df_features)[i][0].split(":")[1]))<0) 
            {dim_2.push(parseInt(Object.entries(df_features)[i][0].split(":")[1]))}
        data.push(df_features[Object.entries(df_features)[i][0]]);
    }
    console.log("sorting ended")
    dim_1 = dim_1.sort()
    dim_2 = dim_2.sort()
        
    var maxNum = dim_1.length
    var buckets = dim_1.length
    
        var margin = { top: 50, right: 0, bottom: 100, left: 30 },
            width = 960 - margin.left - margin.right,
            height = 1500 - margin.top - margin.bottom,
            gridSize = Math.floor(width / buckets),
            legendWidth = (gridSize/2 + 4)
   
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        var mountainColors = ['#ecca96','#e9b97a','#e4a865','#dc9856','#d18954','#c7784c','#c0673f','#b85536','#ad4433'] 
        var waterColors = ['#bed8ec','#a8cee5','#8fc1de','#74b2d7','#5ba3cf','#4592c6','#3181bd','#206fb2','#125ca4'] 
        
       var dim1Labels = svg.selectAll(".dim1Label")
           .data(dim_1)
           .enter().append("text")
             .text(function (d) { return d; })
             .attr("x", 0)
             .attr("y", function (d, i) { return i * gridSize; })
             .style("text-anchor", "end")
             .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
             .attr("class","mono");
   
       var dim2Labels = svg.selectAll(".dim2Label")
           .data(dim_2)
           .enter().append("text")
             .text(function(d) { return d; })
             .attr("x", function(d, i) { return i * gridSize; })
             .attr("y", 0)
             .style("text-anchor", "middle")
             .attr("transform", "translate(" + gridSize / 2 + ", -6)")
             .attr("class","mono");
   
       var heatMap = svg.selectAll(".dim2")
           .data(data)
           .enter().append("rect")
           .attr("x", function(d) { return (d.x) * gridSize; })
           .attr("y", function(d) { return (d.y) * gridSize; })
           .attr("rx", 4)
           .attr("ry", 4)
           .attr("class", "dim2 bordered")
           .attr("width", gridSize-2)
           .attr("height", gridSize-2)
           .style("fill", colors[0])
           .attr("class", "square")
   
       heatMap.transition()
           .style("fill", function(d) { return colorScale(d['elevation']); });
   
       heatMap.append("title").text(function(d) { return d['Type Name']; });
           
       var legend = svg.selectAll(".legend")
           .data([0].concat(colorScale.quantiles()), function(d) { return d; })
           .enter().append("g")
           .attr("class", "legend");
   
       legend.append("rect")
         .attr("x", function(d, i) { return gridSize * buckets; })
         .attr("y", function(d, i) { return (i * legendWidth + 7); })
         .attr("width", gridSize/2)
         .attr("height", gridSize/2)
         .style("fill", function(d, i) { return colors[i]; })
         .attr("class", "square");
   
       legend.append("text")
         .attr("class", "mono")
         .text(function(d) { return "â‰¥ " + Math.round(d); })
         .attr("x", function(d, i) { return gridSize * 11 + 25; })
         .attr("y", function(d, i) { return (i * legendWidth + 20); })
   
       var title = svg.append("text")
             .attr("class", "mono")
             .attr("x", gridSize * 11)
             .attr("y", - 6)         
             .style("font-size", "14px")
             .text("Legend");
   
   var player = svg.append("circle")
   .attr("cx",4* gridSize+(gridSize/2))
   .attr("cy",4* gridSize+(gridSize/2))
   .attr("r",4)
   .attr("fill","#00000")
   
   d3.select("#elevation").on("click", 
   function (d) {
       var mountainScale = d3.scaleLinear().range(mountainColors).domain([d3.min(elevation),d3.max(elevation)]); 
   heatMap.transition()
           .style("fill", function(d) { 
                    if(d['elevation']<0)
                {return "#0077be"}
                    else{return colorScale(d['elevation'])} })
            }
        );       
   
   d3.select("#rainfall").on("click", 
   function (d) {
       var mountainScale = d3.scaleLinear().range(waterColors).domain([d3.min(rainfall),d3.max(rainfall)]); 
   heatMap.transition()
   .style("fill", function(d) { return colorScale(d['rainfall']*10) })
   }
   );
   
   
</script>

